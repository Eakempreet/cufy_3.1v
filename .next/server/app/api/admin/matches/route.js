"use strict";(()=>{var e={};e.id=4527,e.ids=[4527],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},71846:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>Z,originalPathname:()=>x,requestAsyncStorage:()=>v,routeModule:()=>w,serverHooks:()=>j,staticGenerationAsyncStorage:()=>q,staticGenerationBailout:()=>S});var s={};t.r(s),t.d(s,{GET:()=>l,POST:()=>_,dynamic:()=>u,revalidate:()=>d}),t(95655);var a=t(83323),i=t(54647),n=t(66886),o=t(93439);let u="force-dynamic",d=0;async function l(e){try{let{searchParams:r}=new URL(e.url),t=r.get("planType");console.log("Fetching matches data for plan:",t);let s=o.p.from("users").select(`
        id,
        full_name,
        email,
        gender,
        age,
        university,
        profile_photo,
        subscription_type,
        payment_confirmed,
        current_round,
        round_1_completed,
        round_2_completed,
        decision_timer_active,
        decision_timer_expires_at,
        decision_timer_started_at,
        temp_match_id,
        permanent_match_id,
        match_confirmed_at,
        last_activity_at,
        created_at
      `).eq("gender","male").eq("payment_confirmed",!0);t&&"all"!==t&&(s=s.eq("subscription_type",t));let{data:a,error:i}=await s.order("created_at",{ascending:!1});if(i)return console.error("Error fetching male users:",i),n.Z.json({error:"Failed to fetch male users"},{status:500});let{data:u,error:d}=await o.p.from("users").select(`
        id,
        full_name,
        email,
        age,
        university,
        profile_photo,
        bio,
        instagram,
        created_at
      `).eq("gender","female").order("created_at",{ascending:!1});if(d)return console.error("Error fetching female users:",d),n.Z.json({error:"Failed to fetch female users"},{status:500});let{data:l}=await o.p.from("female_profile_stats").select("*"),_=a?.map(e=>e.id)||[],{data:c}=await o.p.from("profile_assignments").select(`
        *,
        female_user:users!profile_assignments_female_user_id_fkey (
          id,
          full_name,
          profile_photo
        )
      `).in("male_user_id",_),{data:m}=await o.p.from("temporary_matches").select(`
        *,
        female_user:users!temporary_matches_female_user_id_fkey (
          id,
          full_name,
          profile_photo
        )
      `).in("male_user_id",_),{data:p}=await o.p.from("permanent_matches").select(`
        *,
        female_user:users!permanent_matches_female_user_id_fkey (
          id,
          full_name,
          profile_photo
        )
      `).in("male_user_id",_),f=a?.map(e=>{var r,t;let s=c?.filter(r=>r.male_user_id===e.id)||[],a=m?.find(r=>r.male_user_id===e.id),i=p?.find(r=>r.male_user_id===e.id),n=(r=e.subscription_type,t=e.current_round,"premium"===r?1===t?2:3:1),o=s.filter(r=>"assigned"===r.status&&r.round_number===e.current_round).length,u=s.find(e=>!0===e.is_selected&&"revealed"===e.status),d=e.decision_timer_active&&e.decision_timer_expires_at&&new Date(e.decision_timer_expires_at)>new Date,l=null;if(d&&e.decision_timer_expires_at){let r=new Date(e.decision_timer_expires_at).getTime(),t=new Date().getTime();l=Math.max(0,r-t)}return{...e,assignments:s,assignedCount:o,revealedCount:s.filter(e=>"revealed"===e.status).length,disengagedCount:s.filter(e=>"disengaged"===e.status).length,maxAssignments:n,availableSlots:n-o,currentTempMatch:a,permanentMatch:i,selectedAssignment:u,hasActiveTimer:d,timeRemaining:l,decisionExpiresAt:e.decision_timer_expires_at,roundInfo:{current:e.current_round,round1Completed:e.round_1_completed,round2Completed:e.round_2_completed,canProgressToRound2:1===e.current_round&&!e.round_1_completed&&(a||i)},status:i?"permanently_matched":a?"temporary_match":u&&d?"deciding":o>0?"assigned":"waiting"}}),g=u?.map(e=>{let r=l?.find(r=>r.female_user_id===e.id),t=c?.filter(r=>r.female_user_id===e.id)||[],s=m?.filter(r=>r.female_user_id===e.id)||[],a=p?.filter(r=>r.female_user_id===e.id)||[];return{...e,currentlyAssignedCount:r?.currently_assigned_count||0,assignedCount:r?.assigned_count||0,totalAssignedCount:r?.total_assigned_count||0,selectedCount:r?.selected_count||0,revealedCount:r?.revealed_count||0,permanentMatchCount:a.length,currentAssignments:t.filter(e=>"assigned"===e.status),currentTempMatches:s.filter(e=>"active"===e.status),lastAssignedAt:r?.last_assigned_at}});return n.Z.json({maleUsers:f||[],femaleUsers:g||[],totalMales:a?.length||0,totalFemales:u?.length||0,statistics:{premiumUsers:f?.filter(e=>"premium"===e.subscription_type).length||0,basicUsers:f?.filter(e=>"basic"===e.subscription_type).length||0,assignedUsers:f?.filter(e=>e.assignedCount>0).length||0,waitingUsers:f?.filter(e=>"waiting"===e.status).length||0,matchedUsers:f?.filter(e=>"permanently_matched"===e.status).length||0}})}catch(e){return console.error("Matches API error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function _(e){try{let r=await e.json(),{action:t,maleUserId:s,femaleUserId:a,data:i}=r;switch(console.log("Matches API POST action:",t),t){case"assign_profile":return await c(s,a,i?.round||1);case"select_profile":return await m(s,a);case"disengage_profile":return await p(s,a);case"confirm_match":return await g(s,a);case"progress_to_round_2":return await f(s);case"clear_history":return await h(s);default:return n.Z.json({error:"Invalid action"},{status:400})}}catch(e){return console.error("Matches API POST error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function c(e,r,t){try{var s,a;let{data:t,error:i}=await o.p.from("users").select("subscription_type, current_round, round_1_completed, round_2_completed, decision_timer_active").eq("id",e).single();if(i||!t)return n.Z.json({error:"Male user not found"},{status:404});if(t.decision_timer_active)return n.Z.json({error:"User has already selected a profile and timer is active. Cannot assign more profiles."},{status:400});let u=(s=t.subscription_type,a=t.current_round,"premium"===s?1===a?2:3:1),{data:d}=await o.p.from("profile_assignments").select("*").eq("male_user_id",e).eq("round_number",t.current_round).eq("status","assigned");if(d&&d.length>=u)return n.Z.json({error:`Maximum assignments reached for round ${t.current_round}. ${t.subscription_type} plan allows ${u} assignments per round.`},{status:400});let{data:l}=await o.p.from("profile_assignments").select("*").eq("male_user_id",e).eq("female_user_id",r).single();if(l){if("disengaged"===l.status)return n.Z.json({error:"This female profile cannot be reassigned to this male user as he disengaged earlier."},{status:400});if("assigned"===l.status)return n.Z.json({error:"This female profile is already assigned to this male user."},{status:400})}let{data:_,error:c}=await o.p.from("profile_assignments").insert({male_user_id:e,female_user_id:r,status:"assigned",round_number:t.current_round,assigned_at:new Date().toISOString()}).select().single();if(c)return console.error("Assignment creation error:",c),n.Z.json({error:"Failed to create assignment"},{status:500});return n.Z.json({success:!0,assignment:_,message:`Profile assigned successfully for Round ${t.current_round}`})}catch(e){return console.error("Assign profile error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function m(e,r){try{let{data:t,error:s}=await o.p.from("profile_assignments").select("*").eq("male_user_id",e).eq("female_user_id",r).eq("status","assigned").single();if(s||!t)return n.Z.json({error:"Assignment not found"},{status:404});let{data:a}=await o.p.from("profile_assignments").select("*").eq("male_user_id",e).eq("is_selected",!0).eq("status","revealed").single();if(a)return n.Z.json({error:"User already has an active selection"},{status:400});let{error:i}=await o.p.rpc("start_decision_timer",{assignment_id:t.id});if(i){console.error("Timer start error:",i);let r=new Date;r.setHours(r.getHours()+48),await o.p.from("profile_assignments").update({is_selected:!0,selected_at:new Date().toISOString(),timer_started_at:new Date().toISOString(),timer_expires_at:r.toISOString(),status:"revealed"}).eq("id",t.id),await o.p.from("users").update({decision_timer_active:!0,decision_timer_started_at:new Date().toISOString(),decision_timer_expires_at:r.toISOString(),last_activity_at:new Date().toISOString()}).eq("id",e),await o.p.from("profile_assignments").update({status:"hidden"}).eq("male_user_id",e).eq("status","assigned").neq("id",t.id)}return n.Z.json({success:!0,message:"Profile selected! 48-hour decision timer started. Other profiles are now hidden."})}catch(e){return console.error("Select profile error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function p(e,r){try{let{error:t}=await o.p.from("profile_assignments").update({status:"disengaged",disengaged_at:new Date().toISOString(),is_selected:!1}).eq("male_user_id",e).eq("female_user_id",r);if(t)return n.Z.json({error:"Failed to update assignment"},{status:500});return await o.p.from("users").update({decision_timer_active:!1,decision_timer_expires_at:null,decision_timer_started_at:null}).eq("id",e),await o.p.from("profile_assignments").update({status:"assigned"}).eq("male_user_id",e).eq("status","hidden"),n.Z.json({success:!0,message:"Profile disengaged successfully. Other profiles are now visible again."})}catch(e){return console.error("Disengage profile error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function f(e){try{let{data:r,error:t}=await o.p.from("users").select("current_round, round_1_completed, subscription_type").eq("id",e).single();if(t||!r)return n.Z.json({error:"User not found"},{status:404});if(1!==r.current_round)return n.Z.json({error:"User is not in round 1"},{status:400});let{error:s}=await o.p.from("users").update({current_round:2,round_1_completed:!0,decision_timer_active:!1,decision_timer_expires_at:null,decision_timer_started_at:null}).eq("id",e);if(s)return n.Z.json({error:"Failed to update user round"},{status:500});return await o.p.from("temporary_matches").update({status:"disengaged"}).eq("male_user_id",e).eq("status","active"),await o.p.from("profile_assignments").update({status:"round_completed"}).eq("male_user_id",e).eq("round_number",1).in("status",["assigned","revealed","hidden"]),n.Z.json({success:!0,message:"Successfully progressed to Round 2! User can now receive new assignments."})}catch(e){return console.error("Progress to round 2 error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function g(e,r){try{let{data:t,error:s}=await o.p.from("permanent_matches").insert({male_user_id:e,female_user_id:r,status:"active"}).select().single();if(s)return n.Z.json({error:"Failed to create permanent match"},{status:500});return await o.p.from("users").update({permanent_match_id:t.id,match_confirmed_at:new Date().toISOString(),decision_timer_active:!1,decision_timer_expires_at:null}).eq("id",e),await o.p.from("temporary_matches").update({status:"promoted"}).eq("male_user_id",e).eq("status","active"),n.Z.json({success:!0,permMatch:t,message:"Match confirmed permanently"})}catch(e){return console.error("Confirm match error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function h(e){try{return await o.p.from("profile_assignments").delete().eq("male_user_id",e),await o.p.from("temporary_matches").delete().eq("male_user_id",e),await o.p.from("permanent_matches").delete().eq("male_user_id",e),await o.p.from("users").update({current_round:1,round_1_completed:!1,round_2_completed:!1,decision_timer_active:!1,decision_timer_expires_at:null,decision_timer_started_at:null,temp_match_id:null,permanent_match_id:null,match_confirmed_at:null,last_activity_at:new Date().toISOString()}).eq("id",e),n.Z.json({success:!0,message:"User history cleared successfully. User reset to Round 1."})}catch(e){return console.error("Clear history error:",e),n.Z.json({error:"Internal server error"},{status:500})}}let y=a.AppRouteRouteModule,w=new y({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/matches/route",pathname:"/api/admin/matches",filename:"route",bundlePath:"app/api/admin/matches/route"},resolvedPagePath:"/home/aman/Desktop/cufy_3.1v-1/app/api/admin/matches/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:q,serverHooks:j,headerHooks:Z,staticGenerationBailout:S}=w,x="/api/admin/matches/route"}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[9195,6886,3433,7221],()=>t(71846));module.exports=s})();