"use strict";(()=>{var e={};e.id=8989,e.ids=[8989],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},97744:(e,r,s)=>{s.r(r),s.d(r,{headerHooks:()=>_,originalPathname:()=>x,requestAsyncStorage:()=>g,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>v});var t={};s.r(t),s.d(t,{POST:()=>d}),s(95655);var o=s(83323),n=s(54647),i=s(66886),a=s(93810),l=s(69542),u=s(93439);async function d(e){try{let r=await (0,a.getServerSession)(l.L);if(!r?.user?.email)return i.Z.json({error:"Unauthorized"},{status:401});let{assignmentId:s}=await e.json();if(!s)return i.Z.json({error:"Assignment ID is required"},{status:400});let{data:t}=await u.p.from("users").select("id, email, gender, current_round, subscription_type").eq("email",r.user.email).single();if(!t)return i.Z.json({error:"User not found"},{status:404});if("male"!==t.gender)return i.Z.json({error:"Only male users can disengage"},{status:403});let{data:o,error:n}=await u.p.from("profile_assignments").select("*").eq("id",s).eq("male_user_id",t.id).single();if(n||!o)return i.Z.json({error:"Assignment not found or unauthorized"},{status:404});if(2===t.current_round)return i.Z.json({error:"Cannot disengage in Round 2 - this is your final choice!"},{status:400});if(!["revealed","selected"].includes(o.status))return i.Z.json({error:"Can only disengage from revealed or selected assignments"},{status:400});console.log(`ðŸ”„ User ${t.email} completely disengaging - removing ALL assignments including selected one...`);let{data:d}=await u.p.from("profile_assignments").select("id, female_user_id, status, is_selected").eq("male_user_id",t.id);console.log(`Found ${d?.length||0} assignments to process`);let m=d?.filter(e=>e.is_selected)||[],c=m.length;if(m.length>0)for(let e of(console.log(`Removing male user from ${m.length} female users' selected lists`),m))await u.p.from("users").update({selected_male_user_id:null,updated_at:new Date().toISOString()}).eq("id",e.female_user_id).eq("selected_male_user_id",t.id),console.log(`âœ… Removed male user ${t.id} from female user ${e.female_user_id}'s selection`);let{error:g}=await u.p.from("profile_assignments").delete().eq("male_user_id",t.id);if(g)return console.error("Error removing all assignments:",g),i.Z.json({error:"Failed to remove all assignments"},{status:500});console.log("âœ… Successfully removed ALL assigned profiles including the selected one");let{error:p}=await u.p.from("temporary_matches").delete().eq("male_user_id",t.id);p?console.error("Error removing temporary matches:",p):console.log("âœ… Successfully removed all temporary matches");let f=t.current_round+1,{error:_}=await u.p.from("users").update({current_round:f,round_1_completed:f>1,decision_timer_active:!1,decision_timer_expires_at:null,decision_timer_started_at:null,selected_male_user_id:null,last_activity_at:new Date().toISOString()}).eq("id",t.id);if(_)return console.error("Error updating user round:",_),i.Z.json({error:`Failed to progress to Round ${f}`},{status:500});return console.log(`âœ… User ${t.email} completely disengaged - ALL profiles removed and female selections updated`),i.Z.json({success:!0,message:"Complete disengage successful! ALL profiles removed and you have been moved to the next round.",nextRound:f,changes:{allAssignmentsRemoved:!0,femaleSelectionsCleared:c>0,affectedFemaleUsers:c,temporaryMatchesRemoved:!0,movedToNextRound:!0,timerReset:!0,completeClear:!0}})}catch(e){return console.error("Disengage error:",e),i.Z.json({error:"Internal server error"},{status:500})}}let m=o.AppRouteRouteModule,c=new m({definition:{kind:n.x.APP_ROUTE,page:"/api/user/disengage/route",pathname:"/api/user/disengage",filename:"route",bundlePath:"app/api/user/disengage/route"},resolvedPagePath:"/home/aman/Desktop/cufy_3.1v-1/app/api/user/disengage/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:p,serverHooks:f,headerHooks:_,staticGenerationBailout:v}=c,x="/api/user/disengage/route"}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[9195,5020,6886,3433,3810,7221,4901,9542],()=>s(97744));module.exports=t})();